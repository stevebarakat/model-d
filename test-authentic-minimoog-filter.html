<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authentic Minimoog Filter Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #1a1a1a;
        color: white;
        line-height: 1.6;
      }
      .info {
        background: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .controls {
        margin: 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: #333;
        color: white;
        border: 1px solid #555;
        cursor: pointer;
        border-radius: 4px;
      }
      button:hover {
        background: #444;
      }
      input[type="range"] {
        width: 200px;
        margin: 10px;
      }
      label {
        display: inline-block;
        width: 150px;
        font-weight: bold;
      }
      .value {
        font-family: monospace;
        background: #333;
        padding: 2px 6px;
        border-radius: 3px;
        min-width: 60px;
        display: inline-block;
        text-align: center;
      }
      .authentic-features {
        background: #1e3a5f;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
      .authentic-features h3 {
        margin-top: 0;
        color: #4fc3f7;
      }
      .authentic-features ul {
        margin: 10px 0;
        padding-left: 20px;
      }
      .authentic-features li {
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <h1>Authentic Minimoog Filter Test</h1>

    <div class="authentic-features">
      <h3>üéõÔ∏è Authentic Minimoog Characteristics</h3>
      <ul>
        <li><strong>Frequency Range:</strong> 10Hz - 32kHz (original spec)</li>
        <li>
          <strong>24dB/Octave:</strong> Classic 4-pole ladder filter response
        </li>
        <li>
          <strong>Transistor Saturation:</strong> Warm, musical distortion
        </li>
        <li>
          <strong>Analog Characteristics:</strong> Thermal noise, temperature
          drift, component tolerances
        </li>
        <li><strong>4x Oversampling:</strong> Improved audio quality</li>
        <li>
          <strong>Authentic Resonance:</strong> Non-linear emphasis curve
          matching original
        </li>
        <li>
          <strong>Self-Oscillation:</strong> Pure sine wave at high resonance
        </li>
      </ul>
    </div>

    <div class="info">
      <h3>Self-Oscillation Guide:</h3>
      <ul>
        <li>
          <strong>Emphasis 0-6:</strong> Normal filtering with subtle resonance
        </li>
        <li>
          <strong>Emphasis 6-8.5:</strong> Increasing resonance, filter starts
          to "sing"
        </li>
        <li>
          <strong>Emphasis 8.5-10:</strong> Self-oscillation range - filter
          becomes an oscillator
        </li>
      </ul>
      <div
        style="
          background: #4a1e1e;
          padding: 10px;
          border-radius: 4px;
          margin-top: 10px;
        "
      >
        <strong>üí° Tip:</strong> Set emphasis to 8.5+ and turn off the input
        oscillator to hear pure self-oscillation!
      </div>
    </div>

    <div class="controls">
      <button id="startBtn">Start Audio</button>
      <button id="playBtn">Play Note</button>
      <button id="stopBtn">Stop Note</button>
      <button id="toggleInputBtn">Toggle Input</button>
    </div>

    <div class="controls">
      <label for="cutoffSlider">Cutoff:</label>
      <input
        type="range"
        id="cutoffSlider"
        min="10"
        max="32000"
        value="1000"
        step="1"
      />
      <span class="value" id="cutoffValue">1000</span> Hz
    </div>

    <div class="controls">
      <label for="emphasisSlider">Emphasis:</label>
      <input
        type="range"
        id="emphasisSlider"
        min="0"
        max="10"
        value="5"
        step="0.1"
      />
      <span class="value" id="emphasisValue">5.0</span>
      <span id="emphasisType">(Normal)</span>
    </div>

    <div class="controls">
      <label for="waveformSelect">Waveform:</label>
      <select id="waveformSelect">
        <option value="sawtooth">Sawtooth</option>
        <option value="square">Square</option>
        <option value="triangle">Triangle</option>
        <option value="sine">Sine</option>
      </select>
    </div>

    <div class="controls">
      <label for="noteSelect">Note:</label>
      <select id="noteSelect">
        <option value="C2">C2 (Low)</option>
        <option value="C3">C3</option>
        <option value="C4" selected>C4 (Middle C)</option>
        <option value="C5">C5</option>
        <option value="C6">C6 (High)</option>
      </select>
    </div>

    <script>
      let audioContext;
      let oscillator;
      let filterNode;
      let inputEnabled = true;

      const noteFrequencies = {
        C2: 65.41,
        C3: 130.81,
        C4: 261.63,
        C5: 523.25,
        C6: 1046.5,
      };

      async function startAudio() {
        if (audioContext) return;

        audioContext = new AudioContext();
        await audioContext.audioWorklet.addModule("moog-zdf-processor.js");

        // Create oscillator
        oscillator = audioContext.createOscillator();
        oscillator.type = "sawtooth";
        oscillator.frequency.setValueAtTime(261.63, audioContext.currentTime);

        // Create Moog ZDF filter
        filterNode = new AudioWorkletNode(audioContext, "moog-zdf-processor");

        // Connect audio chain
        oscillator.connect(filterNode);
        filterNode.connect(audioContext.destination);

        // Start oscillator
        oscillator.start();

        updateFilter();
        document.getElementById("startBtn").textContent = "Audio Started";
        document.getElementById("startBtn").disabled = true;
      }

      function playNote() {
        if (!oscillator) return;

        const note = document.getElementById("noteSelect").value;
        const frequency = noteFrequencies[note];
        oscillator.frequency.setValueAtTime(
          frequency,
          audioContext.currentTime
        );
        console.log(`Playing note: ${note} (${frequency}Hz)`);
      }

      function stopNote() {
        if (!oscillator) return;
        oscillator.frequency.setValueAtTime(0, audioContext.currentTime);
        console.log("Note stopped");
      }

      function toggleInput() {
        if (!oscillator) return;

        inputEnabled = !inputEnabled;
        if (inputEnabled) {
          oscillator.connect(filterNode);
          document.getElementById("toggleInputBtn").textContent =
            "Disable Input";
          console.log("Input enabled");
        } else {
          oscillator.disconnect(filterNode);
          document.getElementById("toggleInputBtn").textContent =
            "Enable Input";
          console.log("Input disabled - pure self-oscillation");
        }
      }

      function updateFilter() {
        if (!filterNode) return;

        const cutoff = parseFloat(
          document.getElementById("cutoffSlider").value
        );
        const emphasis = parseFloat(
          document.getElementById("emphasisSlider").value
        );

        // Use the same mapping as the main app
        const normalizedEmphasis = emphasis / 10; // 0 to 1
        let resonanceValue;

        if (normalizedEmphasis < 0.6) {
          // Linear mapping for lower values (0-6 on emphasis = 0-2.0 resonance)
          resonanceValue = normalizedEmphasis * (2.0 / 0.6);
        } else if (normalizedEmphasis < 0.85) {
          // Curved mapping for middle values (6-8.5 on emphasis = 2.0-3.2 resonance)
          const remaining = normalizedEmphasis - 0.6;
          const curve = Math.pow(remaining / 0.25, 1.2);
          resonanceValue = 2.0 + curve * 1.2;
        } else {
          // Steep curve for self-oscillation (8.5-10 on emphasis = 3.2-4.0 resonance)
          const remaining = normalizedEmphasis - 0.85;
          const steepCurve = Math.pow(remaining / 0.15, 0.8);
          resonanceValue = 3.2 + steepCurve * 0.8;
        }

        resonanceValue = Math.max(0, Math.min(4, resonanceValue));

        // Set filter parameters
        const cutoffParam = filterNode.parameters.get("cutoff");
        const resonanceParam = filterNode.parameters.get("resonance");

        if (cutoffParam) {
          cutoffParam.setValueAtTime(cutoff, audioContext.currentTime);
        }
        if (resonanceParam) {
          resonanceParam.setValueAtTime(
            resonanceValue,
            audioContext.currentTime
          );
        }

        // Update display
        document.getElementById("cutoffValue").textContent = cutoff;
        document.getElementById("emphasisValue").textContent =
          emphasis.toFixed(1);

        // Update emphasis type indicator
        let emphasisType = "Normal";
        if (emphasis >= 8.5) {
          emphasisType = "Self-Oscillation";
        } else if (emphasis >= 6) {
          emphasisType = "High Resonance";
        } else if (emphasis >= 3) {
          emphasisType = "Medium Resonance";
        }
        document.getElementById(
          "emphasisType"
        ).textContent = `(${emphasisType})`;
      }

      function updateWaveform() {
        if (!oscillator) return;
        const waveform = document.getElementById("waveformSelect").value;
        oscillator.type = waveform;
        console.log(`Waveform changed to: ${waveform}`);
      }

      // Event listeners
      document.getElementById("startBtn").addEventListener("click", startAudio);
      document.getElementById("playBtn").addEventListener("click", playNote);
      document.getElementById("stopBtn").addEventListener("click", stopNote);
      document
        .getElementById("toggleInputBtn")
        .addEventListener("click", toggleInput);
      document
        .getElementById("cutoffSlider")
        .addEventListener("input", updateFilter);
      document
        .getElementById("emphasisSlider")
        .addEventListener("input", updateFilter);
      document
        .getElementById("waveformSelect")
        .addEventListener("change", updateWaveform);
      document
        .getElementById("noteSelect")
        .addEventListener("change", playNote);

      // Initialize display
      updateFilter();
    </script>
  </body>
</html>
